# Story 1.5: Test Account System for E2E Testing

## Status

Accepted

## Story

**As a** developer and QA engineer,
**I want** to implement a comprehensive test account system for end-to-end testing,
**so that** I can reliably test user flows, authentication, and application features without affecting production data.

## Acceptance Criteria

1. Test user accounts can be created and managed separately from production users
2. Test accounts have predetermined data sets for consistent testing scenarios
3. E2E test suite can authenticate with test accounts using Playwright MCP
4. Test accounts include varied relationship and journal entry data for comprehensive testing
5. Test data can be reset/cleaned up between test runs
6. Test accounts work with Clerk authentication in test environment
7. Test database isolation prevents interference with development data
8. Playwright test suite covers critical user journeys with test accounts
9. Test accounts include edge cases and boundary conditions for robust testing
10. Test account management is integrated with CI/CD pipeline
11. Test accounts support different user personas and usage patterns

## Tasks / Subtasks

### Test Account Infrastructure

- [ ] **TEST-001**: Set up test environment configuration (AC: 1, 6)
  - [ ] Create test-specific environment variables for Clerk and Convex
  - [ ] Configure separate Convex deployment for testing
  - [ ] Set up test-specific authentication domain and keys
  - [ ] Implement test environment detection and isolation

- [ ] **TEST-002**: Design test account data models (AC: 2, 4)
  - [ ] Define test user personas (new user, active user, power user, edge cases)
  - [ ] Create test relationship data with various types and statuses
  - [ ] Design test journal entries with different moods, tags, and content
  - [ ] Plan test data covering happy path and edge cases

- [ ] **TEST-003**: Implement test data seeding system (AC: 4, 9)
  - [ ] Create Convex functions for test data generation
  - [ ] Build test data factories for users, relationships, and journal entries
  - [ ] Implement test data reset and cleanup mechanisms
  - [ ] Add test data validation and consistency checks

### Test Account Management

- [ ] **TEST-004**: Create test account creation utilities (AC: 1, 3)
  - [ ] Build test user registration helpers for Playwright
  - [ ] Create deterministic test account credentials
  - [ ] Implement test account lifecycle management
  - [ ] Add test account identification and tagging

- [ ] **TEST-005**: Implement test data cleanup and reset (AC: 5, 7)
  - [ ] Create test database cleanup functions
  - [ ] Build automated test data reset between test runs
  - [ ] Implement test isolation to prevent data cross-contamination
  - [ ] Add test data archival for debugging failed tests

- [ ] **TEST-006**: Build test account personas and scenarios (AC: 9, 11)
  - [ ] Create "New User" persona with minimal data
  - [ ] Build "Active User" persona with moderate relationship and journal data
  - [ ] Implement "Power User" persona with extensive data for performance testing
  - [ ] Add "Edge Case User" persona with boundary conditions and unusual data

### Playwright E2E Testing Integration

- [ ] **TEST-007**: Set up Playwright test environment (AC: 3, 8)
  - [ ] Configure Playwright for Resonant application testing
  - [ ] Set up test browser configurations and viewport settings
  - [ ] Implement test authentication helpers using Clerk
  - [ ] Create test navigation and interaction utilities

- [ ] **TEST-008**: Implement authentication flow testing (AC: 3, 6)
  - [ ] Test sign-up flow with test accounts
  - [ ] Test sign-in flow with various test personas
  - [ ] Test authentication state persistence across pages
  - [ ] Test logout and session management

- [ ] **TEST-009**: Create core user journey tests (AC: 8)
  - [ ] Test relationship creation and management flow
  - [ ] Test journal entry creation, editing, and deletion
  - [ ] Test mood selector and tag input functionality
  - [ ] Test relationship picker and multi-select behaviors

- [ ] **TEST-010**: Build advanced feature testing (AC: 8, 9)
  - [ ] Test dashboard data display and real-time updates
  - [ ] Test search and filtering functionality
  - [ ] Test form validation and error handling
  - [ ] Test responsive design across different viewport sizes

### CI/CD Integration and Automation

- [ ] **TEST-011**: Integrate with CI/CD pipeline (AC: 10)
  - [ ] Configure GitHub Actions for automated E2E testing
  - [ ] Set up test environment deployment automation
  - [ ] Implement test result reporting and notifications
  - [ ] Add test failure debugging and screenshot capture

- [ ] **TEST-012**: Create test monitoring and reporting (AC: 10)
  - [ ] Build test execution dashboards and metrics
  - [ ] Implement test performance monitoring
  - [ ] Create test coverage reporting for E2E scenarios
  - [ ] Add automated test maintenance alerts

## Dev Notes

### Testing Architecture Context

**Source: [CLAUDE.md#testing-strategy]**

- **E2E Tests**: Use Playwright MCP for authentication and user flow testing
- **Test Pattern**: Focus on critical user journeys and form validations
- **Authentication**: Requires real email verification in development

### Test Account Requirements

**Source: [CLAUDE.md#playwright-mcp-testing]**

- Authentication requires real email verification in development
- Test authentication flows and component interactions
- Focus on critical user journeys and form validations

### Database Schema for Testing

**Source: [CLAUDE.md#database-schema-convex]**

Test accounts will need realistic data for:
- **users**: User profiles with Clerk integration
- **relationships**: Various relationship types and statuses
- **journalEntries**: Diverse content with moods, tags, and relationships
- **healthScores**: AI-calculated metrics (when implemented)

### Test Environment Configuration

**Required Test Environment Variables:**
```bash
# Test Convex Environment
NEXT_PUBLIC_CONVEX_URL_TEST=        # Test-specific Convex deployment

# Test Clerk Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_TEST=  # Test environment keys
CLERK_SECRET_KEY_TEST=                   # Test environment keys

# Playwright Configuration
PLAYWRIGHT_BASE_URL=http://localhost:3000  # Test application URL
PLAYWRIGHT_HEADLESS=true                   # For CI environment
```

### Test Data Design Patterns

#### Test User Personas

1. **New User (Empty State)**
   - No relationships or journal entries
   - Tests onboarding and first-time user experience

2. **Active User (Moderate Data)**
   - 3-5 relationships with various types
   - 10-15 journal entries with different moods and tags
   - Tests typical user workflows

3. **Power User (Extensive Data)**
   - 10+ relationships with complex data
   - 50+ journal entries spanning multiple months
   - Tests performance and pagination

4. **Edge Case User (Boundary Conditions)**
   - Maximum length content and edge case data
   - Special characters and unicode content
   - Tests validation and error handling

### Playwright Testing Patterns

#### Authentication Flow Testing
```typescript
// Example test pattern for authentication
test('user can sign up and access dashboard', async ({ page }) => {
  await page.goto('/sign-up')
  await signUpWithTestAccount(page, testUsers.newUser)
  await expect(page).toHaveURL('/dashboard')
  await expect(page.getByText('Welcome')).toBeVisible()
})
```

#### Component Interaction Testing
```typescript
// Example test pattern for component interactions
test('user can create journal entry with relationships', async ({ page }) => {
  await authenticateAs(page, testUsers.activeUser)
  await page.goto('/journal/new')
  await fillJournalEntry(page, testJournalData.basicEntry)
  await selectRelationships(page, ['Partner', 'Friend'])
  await page.click('[data-testid="save-entry"]')
  await expect(page.getByText('Entry saved')).toBeVisible()
})
```

### Performance and Scalability Considerations

**Source: [docs/business/PRD.md#technical-requirements]**

- Test accounts should not impact production performance metrics
- Test data volume should reflect realistic usage patterns
- Test isolation prevents performance degradation during development

### Security Considerations

**Source: [docs/architecture/developer-architecture.md#security-architecture]**

- Test accounts use separate authentication keys and environments
- Test data does not contain real personal information
- Test environment isolation prevents security vulnerabilities

## Testing

### Test Account System Validation

#### Unit Tests for Test Utilities
- Test data factory functions for consistency
- Test account creation and cleanup utilities
- Test environment configuration validation

#### Integration Tests for Test Infrastructure
- Test database seeding and cleanup processes
- Test account authentication flows
- Test data isolation between test runs

#### E2E Test Coverage Requirements
- **Authentication Flows**: Sign-up, sign-in, logout, profile management
- **Relationship Management**: Create, edit, delete, search relationships
- **Journal Entry System**: Create, edit, delete, tag, mood selection
- **Dashboard Functionality**: Data display, navigation, real-time updates
- **Form Validation**: Error handling, field validation, success states
- **Responsive Design**: Mobile and desktop viewport testing

#### Performance Testing with Test Accounts
- Page load times with various data volumes
- Component rendering performance with large datasets
- Database query performance with test data

### Test Data Validation Requirements

- Test data must be deterministic and reproducible
- Test accounts must have consistent identifiers for reliable testing
- Test data must cover edge cases and boundary conditions
- Test cleanup must be complete and not leave orphaned data

## Change Log

| Date       | Version | Description                                           | Author       |
| ---------- | ------- | ----------------------------------------------------- | ------------ |
| 2025-07-19 | 1.0     | Initial story creation for test account system       | Scrum Master |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-20250514 (Implementation started: 2025-07-19)

### Debug Log References

To be tracked during implementation

### Completion Notes List

**TEST-001: Set up test environment configuration - COMPLETED (2025-07-19)**
- ✅ Created test environment configuration (.env.test, playwright.config.ts)
- ✅ Set up test directory structure (tests/e2e/, tests/helpers/, tests/fixtures/)
- ✅ Created test user personas with 4 comprehensive user types
- ✅ Implemented test account management system
- ✅ Built test data factory with realistic data generation
- ✅ Created authentication helpers for MCP integration
- ✅ Set up global test setup and teardown systems
- ✅ Fixed TypeScript compilation errors for readonly arrays
- ✅ Validated test infrastructure with successful global setup execution

**Status**: Environment configuration complete, test data seeding working correctly.

**Next**: Configure proper MCP browser integration to complete E2E test execution.

**TEST-001b: Configure proper MCP browser integration - COMPLETED (2025-07-19)**
- ✅ Created MCP-specific Playwright configuration (playwright.mcp.config.ts)
- ✅ Built MCP browser helper abstraction layer
- ✅ Updated global setup to skip local browser launch
- ✅ Added MCP test commands to package.json
- ✅ Created test infrastructure validation
- ✅ Validated MCP configuration runs without browser conflicts
- ✅ Documented complete MCP integration approach in tests/README-MCP-Integration.md

**Status**: MCP browser integration framework complete, ready for actual MCP browser test implementation.

**TEST-002: Create test account management system - COMPLETED (2025-07-19)**
- ✅ Built comprehensive test user personas (4 user types)
- ✅ Created test account management with realistic credentials
- ✅ Implemented authentication helpers for MCP integration

**TEST-003: Implement test data factory system - COMPLETED (2025-07-19)**
- ✅ Created test data factory with realistic data generation
- ✅ Built comprehensive test data seeding for all personas
- ✅ Added edge case and unicode content generation

**TEST-004: Set up Convex test environment - COMPLETED (2025-07-19)**
- ✅ Created Convex test data manager with internal mutations
- ✅ Built simple Convex test client with graceful fallback
- ✅ Implemented Convex configuration validation
- ✅ Added mock operations for test environments without Convex
- ✅ Integrated Convex test client with test environment manager
- ✅ Updated test account manager to use Convex database operations
- ✅ Created test data factory integration with Convex database

**Status**: Convex test environment complete with intelligent fallback to mock operations.

**Next**: Implement E2E authentication tests using MCP browser integration.

### File List

**Test Infrastructure:**
- convex/test-data/ - Test data factories and seeding functions
- tests/e2e/ - Playwright test suites
- tests/fixtures/ - Test data fixtures and utilities
- tests/helpers/ - Test authentication and interaction helpers

**Test Configuration:**
- playwright.config.ts - Playwright configuration
- .env.test - Test environment variables
- jest.config.e2e.js - E2E test configuration
- tests/setup/ - Test setup and teardown utilities

**Test Accounts:**
- tests/accounts/ - Test account definitions and personas
- tests/data/ - Test data sets for each persona
- tests/cleanup/ - Test data cleanup utilities

## QA Results

To be completed during implementation and review phase

### Review Date

To be scheduled

### Reviewed By

To be assigned

### Code Quality Assessment

To be completed during review

### Compliance Check

- [ ] Testing Standards: All tests follow established patterns
- [ ] Test Data Security: No real personal data in test accounts
- [ ] Environment Isolation: Test environment properly separated
- [ ] CI/CD Integration: Automated testing pipeline configured

### Security Review

To be completed focusing on:
- Test environment isolation
- Test account data security
- Authentication flow security in test environment
- Test data cleanup and privacy compliance

### Performance Considerations

To be evaluated for:
- Test execution speed and efficiency
- Test data volume impact on performance
- CI/CD pipeline performance with E2E tests
- Test environment resource usage

### Final Status

To be determined upon completion