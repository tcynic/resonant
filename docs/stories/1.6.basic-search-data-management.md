# Story 1.6: Basic Search & Data Management

## Status

Approved

## Story

**As a** user who has been journaling for a while,
**I want** to search through my journal entries and manage my data privacy,
**so that** I can quickly find specific entries, ensure my data is secure, and have control over my personal information.

## Acceptance Criteria

1. Users can search journal entries by content text with live search results
2. Search functionality filters entries by relationship tags
3. Search results include entry snippets with highlighted search terms
4. Users can access basic privacy settings to control data sharing preferences
5. Users can export their data (journal entries and relationships) in JSON format
6. Entry drafts are automatically saved every 30 seconds when typing
7. Draft entries are recovered when users return to interrupted entry creation
8. Search functionality meets WCAG 2.1 Level AA compliance with full keyboard navigation and screen reader support
9. Data export includes user confirmation and progress indication
10. Privacy settings are clearly explained with user-friendly descriptions
11. Search results return within 500ms for datasets up to 1000 entries with concurrent user support

## Tasks / Subtasks

### Search Infrastructure Implementation

- [ ] **SEARCH-001**: Implement backend search functionality (AC: 1, 2, 8, 11)
  - [ ] Create Convex search functions with full-text search capabilities
  - [ ] Add search indexing for journal entries content and relationship tags
  - [ ] Implement efficient search queries with pagination support
  - [ ] Add search result ranking and relevance scoring

- [ ] **SEARCH-002**: Build frontend search interface (AC: 1, 3, 8)
  - [ ] Create search input component with live search (debounced)
  - [ ] Implement search results display with entry snippets
  - [ ] Add text highlighting for search terms in results
  - [ ] Ensure WCAG 2.1 Level AA compliance with full keyboard navigation
  - [ ] Add screen reader support with proper ARIA labels and descriptions
  - [ ] Implement keyboard shortcuts for search operations

- [ ] **SEARCH-003**: Implement relationship-based filtering (AC: 2)
  - [ ] Add relationship filter dropdown to search interface
  - [ ] Create combined text + relationship filtering logic
  - [ ] Implement clear filters and reset functionality

### Data Management Features

- [ ] **DATA-001**: Implement entry draft auto-save (AC: 6, 7)
  - [ ] Create draft storage system using browser local storage
  - [ ] Add auto-save functionality with 30-second intervals
  - [ ] Implement draft recovery on page load/navigation return
  - [ ] Add visual indicators for draft status and auto-save

- [ ] **DATA-002**: Build data export functionality (AC: 5, 9)
  - [ ] Create data export API endpoints in Convex
  - [ ] Implement frontend export interface with format selection
  - [ ] Add export progress indication and download handling
  - [ ] Include user confirmation dialogs for export actions

- [ ] **DATA-003**: Implement basic privacy settings (AC: 4, 10)
  - [ ] Create privacy settings page with clear options
  - [ ] Add user-friendly descriptions for each privacy setting
  - [ ] Implement settings persistence and validation
  - [ ] Create privacy policy links and explanations

### Performance and User Experience

- [ ] **PERF-001**: Optimize search performance (AC: 11)
  - [ ] Implement search result pagination for large datasets
  - [ ] Add search caching for repeated queries
  - [ ] Optimize database indexes for search performance
  - [ ] Test with large data volumes (up to 1000 entries)
  - [ ] Load test with concurrent users (10+ simultaneous searches)
  - [ ] Verify 500ms response time targets under load

- [ ] **UX-001**: Enhance user experience features (AC: 8, 9, 10)
  - [ ] Add loading states for search and export operations
  - [ ] Implement error handling for search failures
  - [ ] Create user guidance and help text for new features
  - [ ] Add confirmation and success feedback for all operations

### Testing

- [ ] **TEST-001**: Write comprehensive tests (AC: All)
  - [ ] Unit tests for search functionality and data management
  - [ ] Component tests for search interface and privacy settings
  - [ ] Integration tests for auto-save and data export
  - [ ] Performance tests with large datasets

## Dev Notes

### Previous Story Insights

**Source: Story 1.4 & 1.5 Completion**

- Journal entry system is fully operational with mood tracking and relationship tagging
- Test infrastructure is comprehensive with realistic data volumes for testing search performance
- Convex database schema is stable with proper indexing for relationships and journal entries
- TypeScript and testing patterns are well-established for consistent development

### Data Models and Schema

**Source: [docs/architecture/source-tree.md#backend-structure-convex]**

**Existing Database Schema** (from previous stories):

```typescript
// Journal Entries Table (already implemented)
journalEntries: defineTable({
  userId: v.id('users'),
  content: v.string(),
  relationshipIds: v.array(v.id('relationships')),
  mood: v.optional(
    v.object({
      type: v.string(),
      emoji: v.string(),
      intensity: v.number(),
    })
  ),
  tags: v.optional(v.array(v.string())),
  createdAt: v.number(),
  updatedAt: v.number(),
})

// Relationships Table (already implemented)
relationships: defineTable({
  userId: v.id('users'),
  name: v.string(),
  type: v.string(), // 'family', 'friend', 'romantic', 'colleague'
  photoUrl: v.optional(v.string()),
  notes: v.optional(v.string()),
  createdAt: v.number(),
  updatedAt: v.number(),
})

// Users Table (already implemented)
users: defineTable({
  clerkId: v.string(),
  firstName: v.optional(v.string()),
  lastName: v.optional(v.string()),
  email: v.string(),
  privacySettings: v.optional(
    v.object({
      dataSharing: v.boolean(),
      analyticsOptIn: v.boolean(),
      marketingOptIn: v.boolean(),
    })
  ),
  createdAt: v.number(),
  updatedAt: v.number(),
})
```

**Search Index Requirements**:

```typescript
// Required search indexes for Convex
journalEntries: defineTable({...})
  .index('by_user', ['userId'])
  .index('by_user_created', ['userId', 'createdAt'])
  .searchIndex('search_content', {
    searchField: 'content',
    filterFields: ['userId', 'relationshipIds']
  })

relationships: defineTable({...})
  .index('by_user', ['userId'])
```

### Component Specifications

**Source: [docs/architecture/source-tree.md#component-organization]**

**New Search Components Structure**:

```
src/components/features/search/
├── search-bar.tsx                 # Main search input with live search
├── search-results.tsx             # Search results display with pagination
├── search-filters.tsx             # Relationship and date filters
├── highlighted-text.tsx           # Text highlighting for search terms
└── __tests__/
    ├── search-bar.test.tsx
    ├── search-results.test.tsx
    └── search-filters.test.tsx
```

**Data Management Components Structure**:

```
src/components/features/data-management/
├── privacy-settings.tsx           # Privacy settings interface
├── data-export.tsx                # Data export interface and progress
├── draft-recovery.tsx             # Draft recovery notification
└── __tests__/
    ├── privacy-settings.test.tsx
    ├── data-export.test.tsx
    └── draft-recovery.test.tsx
```

### File Locations and Structure

**Source: [docs/architecture/source-tree.md#app-router-structure]**

**New Pages Structure**:

```
src/app/
├── search/
│   ├── page.tsx                   # Main search page
│   └── __tests__/
│       └── search.test.tsx
├── settings/
│   ├── privacy/
│   │   └── page.tsx               # Privacy settings page
│   ├── data/
│   │   └── page.tsx               # Data export page
│   └── __tests__/
│       ├── privacy.test.tsx
│       └── data-export.test.tsx
```

**Backend Functions** (Convex):

```
convex/
├── search.ts                      # Search queries and functions
├── dataExport.ts                  # Data export functions
├── drafts.ts                      # Draft management functions
└── utils/
    ├── search-helpers.ts          # Search utility functions
    └── export-helpers.ts          # Data export utilities
```

### Search Implementation Requirements

**Source: [docs/architecture/tech-stack.md#convex]**

**Convex Search Integration**:

```typescript
// Full-text search query pattern
export const searchJournalEntries = query({
  args: {
    userId: v.id('users'),
    query: v.string(),
    relationshipIds: v.optional(v.array(v.id('relationships'))),
    limit: v.optional(v.number()),
    offset: v.optional(v.number()),
  },
  handler: async (ctx, args) => {
    // Implement full-text search with relationship filtering
    const searchResults = await ctx.db
      .query('journalEntries')
      .withSearchIndex('search_content', q =>
        q
          .search('content', args.query)
          .eq('userId', args.userId)
          .in('relationshipIds', args.relationshipIds || [])
      )
      .paginate({ numItems: args.limit || 20, cursor: args.offset })

    return {
      results: searchResults,
      hasMore: searchResults.isDone,
      nextCursor: searchResults.continueCursor,
    }
  },
})
```

### Auto-Save Implementation Pattern

**Source: [docs/architecture/coding-standards.md#react-nextjs-standards]**

**Auto-Save Hook Pattern**:

```typescript
// Custom hook for auto-save functionality
export function useAutoSave(
  content: string,
  onSave: (content: string) => Promise<void>,
  delay: number = 30000
) {
  const [isDrafted, setIsDrafted] = useState(false)
  const [isAutoSaving, setIsAutoSaving] = useState(false)

  useEffect(() => {
    if (!content.trim()) return

    const timeoutId = setTimeout(async () => {
      setIsAutoSaving(true)
      try {
        await onSave(content)
        setIsDrafted(true)
      } catch (error) {
        console.error('Auto-save failed:', error)
      } finally {
        setIsAutoSaving(false)
      }
    }, delay)

    return () => clearTimeout(timeoutId)
  }, [content, onSave, delay])

  return { isDrafted, isAutoSaving }
}
```

### Privacy Settings Schema

**User Privacy Settings Object**:

```typescript
interface PrivacySettings {
  dataSharing: boolean // Allow data for AI analysis improvements
  analyticsOptIn: boolean // Allow usage analytics collection
  marketingOptIn: boolean // Allow marketing communications
  searchIndexing: boolean // Allow search indexing of entries
  dataRetention: '1year' | '3years' | 'indefinite' // Data retention preference
}
```

### Data Export Format

**Export Data Structure**:

```typescript
interface ExportData {
  exportDate: string
  user: {
    id: string
    name: string
    email: string
    createdAt: string
  }
  relationships: Array<{
    id: string
    name: string
    type: string
    notes: string
    createdAt: string
  }>
  journalEntries: Array<{
    id: string
    content: string
    relationshipNames: string[]
    mood: object | null
    tags: string[]
    createdAt: string
    updatedAt: string
  }>
}
```

### Technical Constraints and Requirements

**Source: [docs/architecture/coding-standards.md#performance-standards]**

**Search Performance Requirements**:

- Search results must return within 500ms for datasets up to 1000 entries
- Performance must be maintained with 10+ concurrent users performing searches
- Live search must be debounced with 300ms delay to reduce server load
- Database queries must be optimized for concurrent access patterns
- Implement proper error handling for search failures and timeout scenarios
- Cache frequently accessed search results to improve response times

**Data Export Requirements**:

- Export must handle large datasets (10MB+ files) with progress indication
- Export must be generated asynchronously for large datasets
- Export format must be human-readable and machine-parseable
- All exports must include data validation and integrity checks

### Security and Privacy Considerations

**Source: [docs/architecture/coding-standards.md#security-standards]**

**Search Security**:

- All search operations must verify user ownership of data
- Search indexes must be user-isolated and not cross-contaminate
- Search queries must be sanitized to prevent injection attacks

**Data Export Security**:

- Export functions must verify user identity and ownership
- Exported data must not include other users' data
- Export downloads must be temporary and automatically cleaned up
- Privacy settings must be validated and enforced during export

### Environment Configuration

**Source: [docs/architecture/tech-stack.md#environment-configuration]**

**No additional environment variables required** - Search and data management use existing Convex and authentication infrastructure.

## Testing

**Source: [docs/architecture/coding-standards.md#testing-standards]**

### Test File Location

- Component tests: `src/components/features/search/__tests__/` and `src/components/features/data-management/__tests__/`
- Page tests: `src/app/search/__tests__/` and `src/app/settings/__tests__/`
- Hook tests: `src/hooks/__tests__/search/` and `src/hooks/__tests__/data-management/`
- Convex function tests: `convex/__tests__/search.test.ts`, `convex/__tests__/dataExport.test.ts`

### Testing Framework Requirements

- **Jest 30.0.4**: Primary testing framework with TypeScript support
- **React Testing Library**: For component testing with user behavior focus
- **@testing-library/jest-dom**: Enhanced DOM assertions

### Specific Testing Requirements for Search & Data Management

- Mock Convex search queries with realistic entry data volumes
- Test search performance with large datasets (up to 1000 entries)
- Load test with concurrent users (10+ simultaneous search operations)
- Verify 500ms response time requirements under concurrent load
- Test auto-save functionality with various timing scenarios
- Test data export with different data volumes and formats
- Verify privacy settings persistence and validation
- Test search accessibility with WCAG 2.1 Level AA compliance
- Test keyboard navigation and screen reader compatibility
- Test error scenarios for search failures, timeouts, and export errors

### Testing Standards Pattern

```typescript
// Search Component Testing Pattern
describe('SearchBar', () => {
  const mockSearchEntries = [
    {
      _id: 'entry-1',
      content: 'Had a great conversation with Sarah about work',
      relationshipIds: ['rel-1'],
      createdAt: Date.now(),
    },
    // ... more test entries
  ]

  it('should perform live search with debouncing', async () => {
    const mockSearch = jest.fn().mockResolvedValue(mockSearchEntries)
    render(<SearchBar onSearch={mockSearch} />)

    const searchInput = screen.getByPlaceholderText('Search journal entries...')

    // Type search query
    await user.type(searchInput, 'Sarah')

    // Should debounce and call search after delay
    await waitFor(() => {
      expect(mockSearch).toHaveBeenCalledWith('Sarah')
    }, { timeout: 1000 })
  })

  it('should handle search errors gracefully', async () => {
    const mockSearch = jest.fn().mockRejectedValue(new Error('Search failed'))
    render(<SearchBar onSearch={mockSearch} />)

    const searchInput = screen.getByPlaceholderText('Search journal entries...')
    await user.type(searchInput, 'test query')

    await waitFor(() => {
      expect(screen.getByText('Search temporarily unavailable')).toBeInTheDocument()
    })
  })

  it('should meet WCAG 2.1 Level AA accessibility requirements', () => {
    render(<SearchBar onSearch={jest.fn()} />)

    const searchInput = screen.getByPlaceholderText('Search journal entries...')

    // Test ARIA labels and descriptions
    expect(searchInput).toHaveAttribute('aria-label', 'Search journal entries')
    expect(searchInput).toHaveAttribute('role', 'searchbox')

    // Test keyboard navigation
    searchInput.focus()
    expect(searchInput).toHaveFocus()

    // Test screen reader announcements
    const searchRegion = screen.getByRole('search')
    expect(searchRegion).toBeInTheDocument()

    // Test keyboard shortcuts (if implemented)
    fireEvent.keyDown(searchInput, { key: 'Enter' })
    // Should trigger search without requiring mouse click
  })
})

// Auto-save Hook Testing Pattern
describe('useAutoSave', () => {
  it('should auto-save content after specified delay', async () => {
    const mockSave = jest.fn().mockResolvedValue(undefined)
    const { rerender } = renderHook(
      ({ content }) => useAutoSave(content, mockSave, 1000),
      { initialProps: { content: '' } }
    )

    // Update content
    rerender({ content: 'Draft content' })

    // Should not save immediately
    expect(mockSave).not.toHaveBeenCalled()

    // Should save after delay
    await waitFor(() => {
      expect(mockSave).toHaveBeenCalledWith('Draft content')
    }, { timeout: 1500 })
  })
})
```

## Change Log

| Date       | Version | Description                                                       | Author        |
| ---------- | ------- | ----------------------------------------------------------------- | ------------- |
| 2025-07-21 | 1.0     | Initial story creation for search and data mgmt                   | Scrum Master  |
| 2025-07-21 | 1.1     | Enhanced AC with specific performance metrics and WCAG compliance | Product Owner |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA agent_
