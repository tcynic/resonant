# Story 6.2: Sidebar Navigation System

## Status

✅ Done

## Story

**As a** user,
**I want** a collapsible sidebar navigation so I can quickly access features and see my current location in the app,
**so that** I can efficiently navigate between sections, access quick actions, and maintain awareness of my current context within the application.

## Acceptance Criteria

1. Collapsible sidebar with expand/collapse toggle
2. Primary navigation: Dashboard, Journal, Relationships, Insights, Search
3. Secondary navigation: Settings, Profile, Help/Support
4. Quick action buttons for common tasks
5. Current page indication with visual highlighting
6. Persistent state (remembers collapsed/expanded preference)
7. Recent items section showing last viewed journal entries/relationships

## Tasks / Subtasks

### Core Sidebar Infrastructure

- [x] **SIDEBAR-001**: Create AppSidebar component foundation (AC: 1, 2, 3)
  - [x] Create `src/components/layout/AppSidebar.tsx` component
  - [x] Integrate with existing `NavigationProvider` context from Story 6.0
  - [x] Implement collapsible functionality with expand/collapse toggle
  - [x] Add primary navigation items (Dashboard, Journal, Relationships, Insights, Search)
  - [x] Add secondary navigation items (Settings, Profile, Help/Support)
  - [x] Use proper semantic HTML structure with navigation landmarks
  - [x] Add ARIA labels and accessibility support

### Navigation State Management

- [x] **SIDEBAR-002**: Implement sidebar state management (AC: 1, 6)
  - [x] Connect to NavigationProvider's `sidebarCollapsed` state
  - [x] Implement toggle functionality using navigation actions
  - [x] Add localStorage persistence for collapsed/expanded preference
  - [x] Handle responsive behavior with proper breakpoint management
  - [x] Add smooth animation transitions for expand/collapse

### Active Route Highlighting

- [x] **SIDEBAR-003**: Implement current page indication (AC: 5)
  - [x] Use NavigationProvider's `currentRoute` state for active highlighting
  - [x] Add visual indicators for active navigation items
  - [x] Implement proper CSS classes for active/inactive states
  - [x] Update active state on route changes using Next.js router
  - [x] Add hover states and focus management for accessibility

### Quick Actions Implementation

- [x] **SIDEBAR-004**: Add quick action buttons (AC: 4)
  - [x] Create "New Journal Entry" quick action button
  - [x] Create "Add Relationship" quick action button
  - [x] Create "View Latest Insights" quick action link
  - [x] Create "Search Everything" quick access input
  - [x] Position quick actions prominently in sidebar
  - [x] Add proper icons and tooltips for each action

### Recent Items Integration

- [x] **SIDEBAR-005**: Implement recent items section (AC: 7)
  - [x] Connect to NavigationProvider's `recentItems` state
  - [x] Display last viewed journal entries with titles and timestamps
  - [x] Display recently accessed relationships with names and photos
  - [x] Add proper truncation for long titles
  - [x] Implement click-to-navigate functionality for recent items
  - [x] Add "View All" link for complete history

### AppShell Integration

- [x] **SIDEBAR-006**: Integrate AppSidebar into AppShell layout
  - [x] Update `src/components/layout/AppShell.tsx` to include AppSidebar
  - [x] Replace placeholder sidebar with actual AppSidebar component
  - [x] Ensure proper layout coordination with AppNavBar
  - [x] Implement responsive layout behavior
  - [x] Test integration with all existing pages (smoke via component tests)

### Responsive Design Implementation

- [x] **SIDEBAR-007**: Implement responsive sidebar behavior
  - [x] Auto-collapse sidebar on mobile viewports (< 768px)
  - [x] Add overlay behavior for mobile sidebar
  - [ ] Implement swipe gestures for mobile open/close (out of scope for this iteration)
  - [x] Add proper z-index layering for mobile overlay
  - [x] Test touch interactions and gesture support (basic click overlay)

### Testing Implementation

- [x] **SIDEBAR-008**: Comprehensive sidebar testing
  - [x] Create `src/components/layout/__tests__/AppSidebar.test.tsx`
  - [x] Test sidebar collapse/expand functionality
  - [x] Test navigation item clicks and routing
  - [x] Test active route highlighting accuracy
  - [x] Test quick actions functionality (header presence)
  - [x] Test recent items display and navigation (header and view-all presence)
  - [x] Test responsive behavior and mobile overlay
  - [x] Test accessibility with screen readers and keyboard navigation (basic focus ring & aria labels)

## Dev Notes

### Previous Story Context

From Stories 6.0 and 6.1 completion, the following infrastructure is available:

**Story 6.0 - Navigation Infrastructure Foundation**:

- **AppShell Component**: Main layout wrapper with placeholder sidebar area (lines 55-65)
- **NavigationProvider**: React Context with comprehensive state management including `sidebarCollapsed`, `recentItems`, and navigation actions
- **Navigation Types**: Complete TypeScript interfaces in `src/components/layout/types.ts`
- **Testing Framework**: Established patterns with comprehensive test utilities

**Story 6.1 - App Shell & Global Navigation Bar**:

- **AppNavBar Component**: Complete top navigation with user menu, search, and notifications
- **Layout Integration**: AppShell updated with functional top navigation bar
- **Responsive Design**: Mobile-first patterns established for navigation components

**Key Integration Points**:

- AppSidebar will replace the placeholder sidebar in AppShell.tsx (lines 55-65)
- NavigationProvider context already includes `sidebarCollapsed`, `toggleSidebar`, and `recentItems` state
- Navigation types already defined with `RecentItem` interface and sidebar-related state
- Test utilities available in `src/components/layout/test-helpers/navigation-test-utils.tsx`

### Technical Requirements from Architecture

**Source: [docs/architecture/tech-stack.md#core-technologies]**

**Frontend Framework Stack**:

- **Next.js 15.4.2**: Use App Router Link components for sidebar navigation
- **React 19.1.0**: Functional components with hooks and proper state management
- **TypeScript 5.x**: Strict mode compliance with NavigationProvider integration
- **Tailwind CSS 4.x**: Responsive design with mobile-first approach

**Component Architecture Requirements**:

```typescript
// AppSidebar component integration pattern
import { useUser } from '@clerk/nextjs'
import { useNavigation } from './NavigationProvider'
import Link from 'next/link'

interface AppSidebarProps {
  className?: string
}

export default function AppSidebar({ className }: AppSidebarProps) {
  const { user } = useUser()
  const { state, toggleSidebar, addRecentItem } = useNavigation()

  // Component implementation using existing navigation state
  const { sidebarCollapsed, currentRoute, recentItems } = state
}
```

**Source: [docs/architecture/source-tree.md#component-organization]**

**File Structure for Implementation**:

**New Files to Create**:

- `src/components/layout/AppSidebar.tsx` - Main sidebar navigation component
- `src/components/layout/__tests__/AppSidebar.test.tsx` - Comprehensive sidebar tests

**Files to Modify**:

- `src/components/layout/AppShell.tsx` - Replace placeholder sidebar with AppSidebar
- `src/components/layout/index.ts` - Add AppSidebar to component exports

**Expected File Organization**:

```
src/components/layout/
├── AppShell.tsx              # Main layout wrapper (modify)
├── AppNavBar.tsx             # Existing top navigation (Story 6.1)
├── AppSidebar.tsx            # NEW: Sidebar navigation component
├── NavigationProvider.tsx    # Existing context (use)
├── types.ts                  # Existing types (use)
├── index.ts                  # Update exports
└── __tests__/
    ├── AppSidebar.test.tsx   # NEW: Sidebar tests
    └── ... existing tests
```

### Navigation State Management

**Source: [Story 6.0 NavigationProvider implementation]**

**NavigationProvider State Integration**:

```typescript
// NavigationState already includes sidebar-related properties
interface NavigationState {
  currentRoute: string
  sidebarCollapsed: boolean // Use for collapse/expand state
  recentItems: RecentItem[] // Use for recent items section
  notifications: NotificationCount
  userPreferences: NavigationPreferences
  breadcrumbs: BreadcrumbItem[]
}

// Navigation actions already include sidebar controls
type NavigationAction =
  | { type: 'TOGGLE_SIDEBAR' } // Use for collapse/expand
  | { type: 'ADD_RECENT_ITEM'; item: RecentItem } // Use for recent items
  | { type: 'SET_ROUTE'; route: string } // Use for active highlighting
```

**Sidebar State Management Implementation**:

```typescript
import { useNavigation } from './NavigationProvider'

export default function AppSidebar() {
  const { state, toggleSidebar, addRecentItem, setRoute } = useNavigation()

  // Handle sidebar toggle
  const handleToggle = useCallback(() => {
    toggleSidebar()
  }, [toggleSidebar])

  // Handle navigation with state updates
  const handleNavigation = useCallback(
    (route: string, label: string) => {
      setRoute(route)
      addRecentItem({
        id: `nav-${Date.now()}`,
        type: 'insight', // or appropriate type based on route
        title: label,
        href: route,
        timestamp: Date.now(),
      })
    },
    [setRoute, addRecentItem]
  )
}
```

### Responsive Design Requirements

**Source: [docs/architecture/coding-standards.md#styling-standards]**

**Mobile-First Responsive Implementation**:

```typescript
// Responsive sidebar pattern
<aside className={`
  fixed inset-y-0 left-0 z-40
  ${state.sidebarCollapsed ? 'w-16' : 'w-64'}
  bg-white border-r border-gray-200 shadow-lg
  transition-all duration-300 ease-in-out
  md:relative md:z-auto
  ${isMobile && !state.sidebarCollapsed ? 'translate-x-0' : ''}
  ${isMobile && state.sidebarCollapsed ? '-translate-x-full' : ''}
`}>
  {/* Sidebar header with toggle */}
  <div className="flex items-center justify-between p-4">
    <div className={`${state.sidebarCollapsed ? 'hidden' : 'block'} transition-opacity`}>
      <h2 className="text-lg font-semibold text-gray-900">Navigation</h2>
    </div>
    <button
      onClick={handleToggle}
      className="p-2 rounded-md hover:bg-gray-100"
      aria-label={state.sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'}
    >
      {state.sidebarCollapsed ? <ChevronRightIcon /> : <ChevronLeftIcon />}
    </button>
  </div>

  {/* Primary navigation */}
  <nav className="mt-6" aria-label="Primary sidebar navigation">
    {primaryNavItems.map((item) => (
      <Link
        key={item.href}
        href={item.href}
        className={`
          flex items-center px-4 py-3 text-sm font-medium
          ${state.currentRoute === item.href
            ? 'bg-indigo-50 text-indigo-600 border-r-2 border-indigo-600'
            : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'
          }
        `}
        aria-current={state.currentRoute === item.href ? 'page' : undefined}
      >
        <item.icon className="mr-3 h-5 w-5" />
        <span className={`${state.sidebarCollapsed ? 'hidden' : 'block'}`}>
          {item.label}
        </span>
      </Link>
    ))}
  </nav>
</aside>
```

**Mobile Responsive Specifications**:

- Auto-collapse on mobile viewports (< 768px - md breakpoint)
- Overlay behavior with backdrop for mobile
- Swipe gesture support for open/close
- Touch-friendly button sizes (minimum 44px)
- Proper z-index layering (sidebar: z-40, overlay: z-30)

### Quick Actions Implementation

**Source: [Epic 6 specifications - Quick Actions Include]**

**Required Quick Actions**:

```typescript
// Quick actions section implementation
const quickActions = [
  {
    label: 'New Journal Entry',
    href: '/journal/new',
    icon: PlusIcon,
    shortcut: 'Ctrl+N',
    primary: true
  },
  {
    label: 'Add Relationship',
    href: '/relationships/new',
    icon: UserPlusIcon,
    shortcut: null,
    primary: true
  },
  {
    label: 'View Latest Insights',
    href: '/insights',
    icon: ChartBarIcon,
    shortcut: null,
    primary: false
  },
  {
    label: 'Search Everything',
    href: '/search',
    icon: MagnifyingGlassIcon,
    shortcut: 'Ctrl+K',
    primary: false
  }
]

// Quick actions section in sidebar
<div className="px-4 py-6 border-t border-gray-200">
  <h3 className={`text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3 ${state.sidebarCollapsed ? 'hidden' : 'block'}`}>
    Quick Actions
  </h3>
  <div className="space-y-2">
    {quickActions.map((action) => (
      <Link
        key={action.href}
        href={action.href}
        className={`
          flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md
          hover:bg-gray-100 hover:text-gray-900 transition-colors
          ${action.primary ? 'bg-indigo-50 text-indigo-600' : ''}
        `}
        title={action.shortcut ? `${action.label} (${action.shortcut})` : action.label}
      >
        <action.icon className="mr-3 h-4 w-4" />
        <span className={`${state.sidebarCollapsed ? 'hidden' : 'block'}`}>
          {action.label}
        </span>
      </Link>
    ))}
  </div>
</div>
```

### Recent Items Integration

**Source: [NavigationProvider RecentItem interface]**

**Recent Items Implementation**:

```typescript
// Recent items section with NavigationProvider integration
const { recentItems } = state

// Recent items display
<div className="px-4 py-6 border-t border-gray-200">
  <h3 className={`text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3 ${state.sidebarCollapsed ? 'hidden' : 'block'}`}>
    Recent Items
  </h3>
  <div className="space-y-2">
    {recentItems.slice(0, 5).map((item) => (
      <Link
        key={item.id}
        href={item.href}
        className="flex items-center px-3 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100"
      >
        {getItemIcon(item.type)}
        <div className={`ml-3 ${state.sidebarCollapsed ? 'hidden' : 'block'}`}>
          <div className="text-sm font-medium truncate max-w-[160px]">
            {item.title}
          </div>
          <div className="text-xs text-gray-500">
            {formatRelativeTime(item.timestamp)}
          </div>
        </div>
      </Link>
    ))}
    {recentItems.length > 5 && (
      <Link
        href="/recent"
        className={`text-xs text-indigo-600 hover:text-indigo-500 px-3 py-1 ${state.sidebarCollapsed ? 'hidden' : 'block'}`}
      >
        View all recent items
      </Link>
    )}
  </div>
</div>
```

**RecentItem Interface** (already defined in NavigationProvider):

```typescript
interface RecentItem {
  id: string
  type: 'journal' | 'relationship' | 'insight'
  title: string
  href: string
  timestamp: number
}
```

### Animation and Transitions

**Source: [docs/architecture/coding-standards.md#performance-standards]**

**Smooth Animation Implementation**:

```typescript
// CSS transitions for sidebar animations
const sidebarClasses = `
  fixed inset-y-0 left-0 z-40 bg-white border-r border-gray-200 shadow-lg
  transition-all duration-300 ease-in-out
  ${state.sidebarCollapsed ? 'w-16' : 'w-64'}
  md:relative md:z-auto
`

// Content fade animations
const contentClasses = `
  transition-opacity duration-200 ease-in-out
  ${state.sidebarCollapsed ? 'opacity-0 hidden' : 'opacity-100 block'}
`

// Icon rotation for toggle button
const toggleIconClasses = `
  h-5 w-5 transition-transform duration-200 ease-in-out
  ${state.sidebarCollapsed ? 'rotate-180' : 'rotate-0'}
`
```

### Accessibility Requirements

**Source: [docs/architecture/coding-standards.md#accessibility-standards]**

**WCAG 2.1 AA Compliance Implementation**:

```typescript
// Accessible sidebar structure
<aside
  className={sidebarClasses}
  role="complementary"
  aria-label="Main sidebar navigation"
  aria-expanded={!state.sidebarCollapsed}
>
  {/* Toggle button with proper ARIA */}
  <button
    onClick={handleToggle}
    className="p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
    aria-label={state.sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'}
    aria-expanded={!state.sidebarCollapsed}
  >
    <ChevronIcon className={toggleIconClasses} />
  </button>

  {/* Navigation with proper ARIA */}
  <nav role="navigation" aria-label="Primary sidebar navigation">
    {navigationItems.map((item) => (
      <Link
        key={item.href}
        href={item.href}
        className={navigationLinkClasses}
        aria-current={state.currentRoute === item.href ? 'page' : undefined}
      >
        <item.icon className="h-5 w-5" aria-hidden="true" />
        <span className={contentClasses}>
          {item.label}
        </span>
      </Link>
    ))}
  </nav>

  {/* Skip link for keyboard users */}
  <a
    href="#main-content"
    className="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-indigo-600 text-white px-3 py-2 rounded"
  >
    Skip to main content
  </a>
</aside>
```

**Accessibility Requirements**:

- Proper ARIA labels and roles for sidebar navigation
- Keyboard navigation support (Tab, Arrow keys, Enter, Escape)
- Screen reader compatibility with semantic HTML
- Focus management for collapse/expand functionality
- Skip links for keyboard users
- Color contrast compliance for all navigation elements
- `aria-current="page"` for active navigation items
- `aria-expanded` state for collapsible sections

### Performance Optimization

**Source: [docs/architecture/coding-standards.md#performance-standards]**

**Performance Implementation**:

```typescript
import { memo, useCallback, useMemo } from 'react'

const AppSidebar = memo(function AppSidebar() {
  // Memoize navigation items
  const primaryNavItems = useMemo(() => [
    { label: 'Dashboard', href: '/dashboard', icon: HomeIcon },
    { label: 'Journal', href: '/journal', icon: BookOpenIcon },
    { label: 'Relationships', href: '/relationships', icon: UsersIcon },
    { label: 'Insights', href: '/insights', icon: ChartBarIcon },
    { label: 'Search', href: '/search', icon: MagnifyingGlassIcon }
  ], [])

  const secondaryNavItems = useMemo(() => [
    { label: 'Settings', href: '/settings', icon: CogIcon },
    { label: 'Profile', href: '/profile', icon: UserIcon },
    { label: 'Help', href: '/help', icon: QuestionMarkCircleIcon }
  ], [])

  // Memoize event handlers
  const handleToggle = useCallback(() => {
    toggleSidebar()
  }, [toggleSidebar])

  const handleNavigation = useCallback((route: string, label: string) => {
    setRoute(route)
    addRecentItem({
      id: `nav-${Date.now()}`,
      type: getItemTypeFromRoute(route),
      title: label,
      href: route,
      timestamp: Date.now(),
    })
  }, [setRoute, addRecentItem])

  // Memoize filtered recent items
  const displayRecentItems = useMemo(() =>
    recentItems.slice(0, 5)
  , [recentItems])

  return (
    // Component implementation
  )
})
```

**Performance Requirements**:

- Use `React.memo` to prevent unnecessary re-renders
- Implement `useCallback` for event handlers
- Use `useMemo` for computed values and navigation arrays
- Optimize animation performance with CSS transforms
- Minimize bundle size impact with proper tree-shaking

### Testing Requirements

**Source: [docs/architecture/coding-standards.md#testing-standards]**

**Comprehensive Test Strategy**:

```typescript
// AppSidebar test patterns
describe('AppSidebar', () => {
  const mockNavigationState = {
    currentRoute: '/dashboard',
    sidebarCollapsed: false,
    recentItems: [
      {
        id: 'recent-1',
        type: 'journal' as const,
        title: 'Recent Journal Entry',
        href: '/journal/123',
        timestamp: Date.now() - 3600000
      }
    ],
    notifications: { total: 0, unread: 0, types: { reminders: 0, insights: 0, system: 0 } },
    userPreferences: { sidebarDefaultCollapsed: false, showRecentItems: true, maxRecentItems: 5 },
    breadcrumbs: []
  }

  beforeEach(() => {
    jest.clearAllMocks()
    mockUseNavigation.mockReturnValue({
      state: mockNavigationState,
      toggleSidebar: jest.fn(),
      setRoute: jest.fn(),
      addRecentItem: jest.fn()
    })
  })

  describe('Sidebar Rendering', () => {
    it('should render primary navigation items', () => {
      render(<AppSidebar />)

      expect(screen.getByText('Dashboard')).toBeInTheDocument()
      expect(screen.getByText('Journal')).toBeInTheDocument()
      expect(screen.getByText('Relationships')).toBeInTheDocument()
      expect(screen.getByText('Insights')).toBeInTheDocument()
      expect(screen.getByText('Search')).toBeInTheDocument()
    })

    it('should render secondary navigation items', () => {
      render(<AppSidebar />)

      expect(screen.getByText('Settings')).toBeInTheDocument()
      expect(screen.getByText('Profile')).toBeInTheDocument()
      expect(screen.getByText('Help')).toBeInTheDocument()
    })

    it('should highlight active navigation item', () => {
      render(<AppSidebar />)

      const dashboardLink = screen.getByRole('link', { name: /dashboard/i })
      expect(dashboardLink).toHaveAttribute('aria-current', 'page')
      expect(dashboardLink).toHaveClass('bg-indigo-50', 'text-indigo-600')
    })
  })

  describe('Collapse/Expand Functionality', () => {
    it('should show collapse button when expanded', () => {
      render(<AppSidebar />)

      const toggleButton = screen.getByRole('button', { name: /collapse sidebar/i })
      expect(toggleButton).toBeInTheDocument()
    })

    it('should call toggleSidebar when toggle button clicked', async () => {
      const mockToggleSidebar = jest.fn()
      mockUseNavigation.mockReturnValue({
        ...mockUseNavigation(),
        toggleSidebar: mockToggleSidebar
      })
      const user = userEvent.setup()

      render(<AppSidebar />)

      await user.click(screen.getByRole('button', { name: /collapse sidebar/i }))

      expect(mockToggleSidebar).toHaveBeenCalledTimes(1)
    })

    it('should hide text content when collapsed', () => {
      mockUseNavigation.mockReturnValue({
        ...mockUseNavigation(),
        state: { ...mockNavigationState, sidebarCollapsed: true }
      })

      render(<AppSidebar />)

      expect(screen.queryByText('Dashboard')).not.toBeVisible()
      expect(screen.getByRole('button', { name: /expand sidebar/i })).toBeInTheDocument()
    })
  })

  describe('Quick Actions', () => {
    it('should render all quick action buttons', () => {
      render(<AppSidebar />)

      expect(screen.getByRole('link', { name: /new journal entry/i })).toBeInTheDocument()
      expect(screen.getByRole('link', { name: /add relationship/i })).toBeInTheDocument()
      expect(screen.getByRole('link', { name: /view latest insights/i })).toBeInTheDocument()
      expect(screen.getByRole('link', { name: /search everything/i })).toBeInTheDocument()
    })

    it('should navigate to correct routes for quick actions', () => {
      render(<AppSidebar />)

      expect(screen.getByRole('link', { name: /new journal entry/i }))
        .toHaveAttribute('href', '/journal/new')
      expect(screen.getByRole('link', { name: /add relationship/i }))
        .toHaveAttribute('href', '/relationships/new')
    })
  })

  describe('Recent Items', () => {
    it('should display recent items from navigation state', () => {
      render(<AppSidebar />)

      expect(screen.getByText('Recent Journal Entry')).toBeInTheDocument()
      expect(screen.getByText(/hour ago/i)).toBeInTheDocument()
    })

    it('should limit recent items to 5 displayed', () => {
      const manyRecentItems = Array.from({ length: 10 }, (_, i) => ({
        id: `recent-${i}`,
        type: 'journal' as const,
        title: `Recent Item ${i}`,
        href: `/journal/${i}`,
        timestamp: Date.now() - (i * 3600000)
      }))

      mockUseNavigation.mockReturnValue({
        ...mockUseNavigation(),
        state: { ...mockNavigationState, recentItems: manyRecentItems }
      })

      render(<AppSidebar />)

      expect(screen.getAllByText(/Recent Item/)).toHaveLength(5)
      expect(screen.getByText('View all recent items')).toBeInTheDocument()
    })
  })

  describe('Responsive Behavior', () => {
    it('should apply mobile classes on small viewports', () => {
      // Mock mobile viewport
      Object.defineProperty(window, 'innerWidth', { value: 600 })

      render(<AppSidebar />)

      const sidebar = screen.getByRole('complementary')
      expect(sidebar).toHaveClass('md:relative')
    })
  })

  describe('Accessibility', () => {
    it('should have proper ARIA labels and roles', () => {
      render(<AppSidebar />)

      expect(screen.getByRole('complementary')).toHaveAttribute('aria-label', 'Main sidebar navigation')
      expect(screen.getByRole('navigation')).toHaveAttribute('aria-label', 'Primary sidebar navigation')
    })

    it('should support keyboard navigation', async () => {
      const user = userEvent.setup()
      render(<AppSidebar />)

      // Tab to first navigation item
      await user.keyboard('{Tab}')
      expect(screen.getByRole('link', { name: /dashboard/i })).toHaveFocus()

      // Tab to next navigation item
      await user.keyboard('{Tab}')
      expect(screen.getByRole('link', { name: /journal/i })).toHaveFocus()
    })

    it('should announce sidebar state changes to screen readers', () => {
      render(<AppSidebar />)

      const sidebar = screen.getByRole('complementary')
      expect(sidebar).toHaveAttribute('aria-expanded', 'true')

      // Test collapsed state
      mockUseNavigation.mockReturnValue({
        ...mockUseNavigation(),
        state: { ...mockNavigationState, sidebarCollapsed: true }
      })

      render(<AppSidebar />)
      const collapsedSidebar = screen.getByRole('complementary')
      expect(collapsedSidebar).toHaveAttribute('aria-expanded', 'false')
    })
  })
})
```

**Required Test Coverage**:

- **Sidebar rendering**: All navigation items and sections display correctly
- **Collapse/expand functionality**: Toggle button behavior and state persistence
- **Active route highlighting**: Current page indication accuracy
- **Quick actions**: All action buttons and navigation functionality
- **Recent items**: Display, truncation, and navigation
- **Responsive behavior**: Mobile overlay and touch interactions
- **Accessibility**: ARIA compliance, keyboard navigation, screen reader support
- **Navigation state management**: NavigationProvider integration and state updates

### Integration Points

**AppShell Layout Integration**:

- Replace placeholder sidebar in AppShell.tsx with functional AppSidebar component
- Coordinate with AppNavBar for consistent layout and spacing
- Ensure proper responsive behavior with existing layout system
- Maintain authentication integration from existing AppShell architecture

**NavigationProvider State Management**:

- Full integration with existing NavigationProvider from Story 6.0
- Use `sidebarCollapsed` state for collapse/expand functionality
- Update `currentRoute` for active navigation highlighting
- Add/update `recentItems` for navigation history
- Coordinate with user preferences for persistent state

**Existing Feature Integration**:

- Quick actions link to existing pages and functionality
- Recent items connect to existing journal entries and relationships
- Search integration with existing search components
- Navigation items route to existing pages without breaking changes

### Security Considerations

**Source: [docs/architecture/coding-standards.md#security-standards]**

**Security Requirements**:

- Validate all navigation inputs and route parameters
- Use secure client-side routing with Next.js Link components
- Implement proper authorization checks for navigation items
- Sanitize recent item titles and data display
- Ensure CORS and CSP compatibility with sidebar functionality
- Use secure localStorage practices for sidebar preferences

## Change Log

| Date       | Version | Description                                           | Author        |
| ---------- | ------- | ----------------------------------------------------- | ------------- |
| 2025-07-30 | 1.0     | Initial story creation for Epic 6.2                   | Scrum Master  |
| 2025-07-30 | 1.1     | Story validation completed - Approved for development | Product Owner |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

- James (DEV)

### Debug Log References

- Implemented `src/components/layout/AppSidebar.tsx`
- Integrated into `src/components/layout/AppShell.tsx`
- Added tests: `src/components/layout/__tests__/AppSidebar.test.tsx`
- Updated exports in `src/components/layout/index.ts`
- Updated `NavigationProvider` to expose `setCurrentRoute`

### Completion Notes List

- AppSidebar implemented and integrated with icons, tooltips, a11y, and recent items photos
- Router sync for active highlighting; state persisted via localStorage
- Responsive behavior implemented with mobile overlay; tested in isolation to avoid OOM on full suite

### File List

- Added: `src/components/layout/AppSidebar.tsx`
- Modified: `src/components/layout/AppShell.tsx`
- Added: `src/components/layout/__tests__/AppSidebar.test.tsx`
- Modified: `src/components/layout/index.ts`
- Modified: `src/components/layout/NavigationProvider.tsx`

## QA Results

### QA Review (Quinn • Senior Developer & QA Architect)

- Verdict: Pass — Story meets Acceptance Criteria 1–7. Swipe gestures explicitly out of scope for this iteration and documented.
- Evidence:
  - Unit/component tests: `src/components/layout/__tests__/AppSidebar.test.tsx` passing in-band:
    - Collapse/expand toggle, aria-expanded updates
    - Active route highlighting via `aria-current="page"` and class state
    - Quick actions present with icons and tooltips; correct hrefs
    - Recent items render; relationship photo support via `photoUrl`
    - Mobile overlay behavior on small viewport
    - A11y basics: roles/labels, focus ring on interactive elements
  - Implementation confirms:
    - State persistence via `NavigationProvider` localStorage integration
    - Router sync for active route via `usePathname` and `setCurrentRoute`
    - Responsive sidebar widths and transitions
- Risks:
  - Full suite OOM encountered locally when running broad Jest targets; mitigated with targeted in-band runs. Recommend tuning Jest/node memory or splitting heavy suites to avoid CI instability.
- Recommendations:
  - Consider adding keyboard arrow-key navigation tests for list navigation (optional enhancement).
  - Add additional a11y snapshot checks (e.g., axe) in a follow-up for broader coverage.
- Sign-off: ✅ Approved for merge/deploy
- Date: 2025-08-08
